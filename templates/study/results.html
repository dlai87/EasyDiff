{% extends "base.html" %}

{% block title %}Results - {{ study.name }}{% endblock %}

{% block content %}
<div class="container py-8">
    <div class="mb-6">
        <a href="{{ url_for('dashboard') }}" class="text-sm text-muted">&larr; Back to Dashboard</a>
    </div>

    <div class="flex justify-between items-start mb-6">
        <div>
            <h1>{{ study.name }}</h1>
            <p class="text-muted">Results & Analysis</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('study_export', id=study.id) }}" class="btn btn-secondary">Export CSV</a>
            <a href="{{ url_for('study_edit', id=study.id) }}" class="btn btn-secondary">Settings</a>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="results-summary">
        <div class="stat-card">
            <div class="stat-value">{{ stats.completed_responses }}</div>
            <div class="stat-label">Completed Responses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.in_progress_responses }}</div>
            <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.completion_rate }}%</div>
            <div class="stat-label">Completion Rate</div>
        </div>
    </div>

    {% if stats.completed_responses > 0 %}
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-6);">
            <!-- Preference Ranking -->
            <div class="card">
                <div class="card-header">
                    <div class="title-with-info">
                        <h2 class="card-title">Preference Ranking</h2>
                        <span class="info-tooltip">
                            <span class="info-icon">?</span>
                            <span class="tooltip-content">Items are ranked using the Best-Worst Counting method. Raw Score = (Best selections) - (Worst selections). Scores are normalized to 0-100 where 100 = most preferred and 0 = least preferred.</span>
                        </span>
                    </div>
                    <p class="card-description">Items ranked by preference score (0-100)</p>
                </div>

                <ul class="ranking-list">
                    {% for item_id, data in ranked_items %}
                        <li class="ranking-item">
                            <span class="ranking-position {{ 'top-3' if loop.index <= 3 else '' }}">{{ loop.index }}</span>
                            <span class="ranking-text">{{ data.name }}</span>
                            <span class="ranking-score">{{ data.normalized_score }}</span>
                            <div class="ranking-bar">
                                <div class="ranking-bar-fill" style="width: {{ data.normalized_score }}%"></div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Best/Worst Counts -->
            <div class="card">
                <div class="card-header">
                    <div class="title-with-info">
                        <h2 class="card-title">Best vs. Worst Selection Chart</h2>
                        <span class="info-tooltip">
                            <span class="info-icon">?</span>
                            <span class="tooltip-content">Shows how many times each item was selected as Best (green, left) versus Worst (red, right). Items with more Best and fewer Worst selections have higher preference scores.</span>
                        </span>
                    </div>
                    <p class="card-description">Best vs Worst selection counts</p>
                </div>

                <div class="tornado-chart">
                    {% for item_id, data in ranked_items %}
                        {% set max_count = namespace(value=1) %}
                        {% for _, d in ranked_items %}
                            {% if d.best_count > max_count.value %}
                                {% set max_count.value = d.best_count %}
                            {% endif %}
                            {% if d.worst_count > max_count.value %}
                                {% set max_count.value = d.worst_count %}
                            {% endif %}
                        {% endfor %}

                        <div class="tornado-item">
                            <div class="tornado-bar-container tornado-bar-left">
                                <div class="tornado-bar tornado-bar-best" style="width: {{ (data.best_count / max_count.value * 100) if max_count.value > 0 else 0 }}%; min-width: {{ '20px' if data.best_count > 0 else '0' }};">
                                </div>
                                <span class="text-xs text-muted" style="margin-left: 4px;">{{ data.best_count }}</span>
                            </div>
                            <span class="tornado-label">{{ data.name[:25] }}{% if data.name|length > 25 %}...{% endif %}</span>
                            <div class="tornado-bar-container tornado-bar-right">
                                <span class="text-xs text-muted" style="margin-right: 4px;">{{ data.worst_count }}</span>
                                <div class="tornado-bar tornado-bar-worst" style="width: {{ (data.worst_count / max_count.value * 100) if max_count.value > 0 else 0 }}%; min-width: {{ '20px' if data.worst_count > 0 else '0' }};"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="flex justify-center gap-6 mt-4 text-sm">
                    <span class="flex items-center gap-2">
                        <span style="width: 12px; height: 12px; background: var(--success); border-radius: 2px;"></span>
                        {{ study.best_label }} selections
                    </span>
                    <span class="flex items-center gap-2">
                        <span style="width: 12px; height: 12px; background: var(--danger); border-radius: 2px;"></span>
                        {{ study.worst_label }} selections
                    </span>
                </div>
            </div>
        </div>

        <!-- Raw Data Table -->
        <div class="card mt-6">
            <div class="card-header">
                <div class="title-with-info">
                    <h2 class="card-title">Detailed Scores</h2>
                    <span class="info-tooltip">
                        <span class="info-icon">?</span>
                        <span class="tooltip-content">Score: Normalized preference (0-100). Raw Score: Best count minus Worst count. Best/Worst Count: Times selected as best or worst. Appearances: How often the item appeared in question sets.</span>
                    </span>
                </div>
                <p class="card-description">Raw count data for each item</p>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Item</th>
                        <th>Score</th>
                        <th>Raw Score</th>
                        <th>Best Count</th>
                        <th>Worst Count</th>
                        <th>Appearances</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_id, data in ranked_items %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ data.name }}</td>
                            <td><strong>{{ data.normalized_score }}</strong></td>
                            <td>{{ data.raw_score }}</td>
                            <td class="text-success">{{ data.best_count }}</td>
                            <td class="text-danger">{{ data.worst_count }}</td>
                            <td>{{ data.appearances }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pre-Survey Question Results -->
        {% if custom_question_results %}
        <div class="card mt-6">
            <div class="card-header">
                <h2 class="card-title">Pre-Survey Question Results</h2>
                <p class="card-description">Responses to custom questions asked before the MaxDiff comparison</p>
            </div>

            {% for result in custom_question_results %}
                <div class="custom-question-result {% if not loop.last %}mb-6{% endif %}">
                    <h3 class="text-lg font-semibold mb-2">{{ result.question.question_text }}</h3>
                    <p class="text-sm text-muted mb-3">
                        {{ result.type | replace('_', ' ') | title }}
                        {% if result.question.is_required %} - Required{% else %} - Optional{% endif %}
                    </p>

                    {% if result.type == 'text' %}
                        {% if result.responses %}
                            <div class="text-responses">
                                {% for response in result.responses %}
                                    <div class="text-response-item">
                                        <p>{{ response }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No text responses</p>
                        {% endif %}

                    {% elif result.type == 'rating_scale' %}
                        <div class="rating-result">
                            <div class="rating-summary mb-4">
                                <span class="stat-value">{{ result.average }}</span>
                                <span class="text-muted"> average rating ({{ result.count }} responses)</span>
                            </div>
                            <div class="rating-distribution">
                                {% for value, count in result.distribution.items() %}
                                    {% set pct = (count / result.count * 100) if result.count > 0 else 0 %}
                                    <div class="rating-dist-item">
                                        <span class="rating-dist-label">{{ value }}</span>
                                        <div class="option-bar">
                                            <div class="option-bar-fill" style="width: {{ pct }}%"></div>
                                        </div>
                                        <span class="rating-dist-count">{{ count }} ({{ pct|round(1) }}%)</span>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if result.config.min_label or result.config.max_label %}
                                <div class="flex justify-between text-sm text-muted mt-2">
                                    <span>{{ result.config.min_label or '' }}</span>
                                    <span>{{ result.config.max_label or '' }}</span>
                                </div>
                            {% endif %}
                        </div>

                    {% elif result.type in ['single_choice', 'multiple_choice'] %}
                        <div class="option-results">
                            {% for opt_id, opt_data in result.option_counts.items() %}
                                <div class="option-result-item">
                                    <div class="option-result-header">
                                        <span class="option-result-text">{{ opt_data.option.option_text }}</span>
                                        <span class="option-result-count">{{ opt_data.count }} ({{ opt_data.percentage }}%)</span>
                                    </div>
                                    <div class="option-bar">
                                        <div class="option-bar-fill" style="width: {{ opt_data.percentage }}%"></div>
                                    </div>
                                </div>
                            {% endfor %}
                            <p class="text-sm text-muted mt-2">{{ result.total_responses }} total responses</p>
                        </div>
                    {% endif %}
                </div>

                {% if not loop.last %}
                    <hr class="my-6" style="border-color: var(--border);">
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    {% else %}
        <div class="card">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“ˆ</div>
                <h3>No responses yet</h3>
                <p class="text-muted">Share your survey link to start collecting responses</p>
                {% if study.status == 'ACTIVE' %}
                    <div class="share-link-container max-w-lg" style="margin: var(--space-6) auto 0;">
                        <input
                            type="text"
                            id="share-url"
                            class="form-input share-link-input"
                            value="{{ url_for('survey_start', token=study.share_token, _external=True) }}"
                            readonly
                        >
                        <button type="button" class="btn btn-primary" data-copy="share-url">Copy Link</button>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
